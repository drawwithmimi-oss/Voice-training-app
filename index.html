<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Voice Training Companion - Reading Edition</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dyslexia-friendly font and spacing */
        .reading-text {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 2;
            letter-spacing: 0.05em;
            word-spacing: 0.2em;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Mobile-optimized touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Floating bubble styles */
        .floating-bubble {
            position: fixed;
            right: 20px;
            bottom: 80px;
            z-index: 1000;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .pitch-indicator {
            transition: all 0.3s ease;
        }
        
        /* Prevent text selection on buttons */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* iOS safe areas */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        function VoiceTrainingReader() {
            const [isDronePlaying, setIsDronePlaying] = useState(false);
            const [selectedNote, setSelectedNote] = useState('C4');
            const [currentPitch, setCurrentPitch] = useState(0);
            const [micPermission, setMicPermission] = useState('pending');
            const [audioInitialized, setAudioInitialized] = useState(false);
            const [showBubble, setShowBubble] = useState(false);
            const [bubbleExpanded, setBubbleExpanded] = useState(false);
            const [selectedReading, setSelectedReading] = useState(null);
            const [fontSize, setFontSize] = useState('large');
            
            const audioContextRef = useRef(null);
            const oscillatorRef = useRef(null);
            const gainNodeRef = useRef(null);
            const analyserRef = useRef(null);
            const micStreamRef = useRef(null);
            const pitchDetectionRef = useRef(null);

            const notes = {
                'A3': 220.00,
                'B3': 246.94,
                'C4': 261.63,
                'C#4': 277.18,
                'D4': 293.66,
                'D#4': 311.13,
                'E4': 329.63,
                'F4': 349.23,
                'F#4': 369.99,
                'G4': 392.00
            };

            const readings = [
                {
                    id: 'rainbow',
                    title: 'Rainbow Passage',
                    description: 'Classic voice training text',
                    content: `When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look, but no one ever finds it. When a person looks for something beyond their reach, their friends say they are looking for the pot of gold at the end of the rainbow.

Throughout the centuries people have explained the rainbow in various ways. Some have accepted it as a miracle without physical explanation. Others have tried to explain the phenomenon physically. Aristotle thought that the rainbow was caused by reflection of the sun's rays by the rain. Since then physicists have found that it is not reflection, but refraction by the raindrops which causes the rainbows.

Many complicated ideas about the rainbow have been formed. The difference in the rainbow depends considerably upon the size of the drops, and the width of the colored band increases as the size of the drops increases. The actual primary rainbow observed is said to be the effect of superimposition of a number of bows. If the red of the second bow falls upon the green of the first, the result is a bow with an abnormally wide yellow band, since red and green light when mixed form yellow. This is a very common type of bow, one showing mainly red and yellow, with little or no green or blue.`
                },
                {
                    id: 'quick',
                    title: 'Quick Practice Sentences',
                    description: 'Short sentences for warm-up',
                    content: `The early morning brings new opportunities.

She speaks with confidence and clarity.

My voice flows naturally and freely.

Practice makes progress, not perfection.

Each day I grow more comfortable with my voice.

Speaking authentically is my goal.

The melody of speech comes from within.

I embrace my unique vocal qualities.`
                }
            ];

            // Initialize Audio Context
            const initAudio = useCallback(async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    micStreamRef.current = stream;
                    setMicPermission('granted');
                    
                    if (!audioContextRef.current) {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    analyserRef.current = audioContextRef.current.createAnalyser();
                    analyserRef.current.fftSize = 2048;
                    source.connect(analyserRef.current);
                    
                    setAudioInitialized(true);
                    startPitchDetection();
                    
                } catch (error) {
                    console.error('Microphone error:', error);
                    setMicPermission('denied');
                }
            }, []);

            // Pitch Detection
            const startPitchDetection = useCallback(() => {
                if (!analyserRef.current || !audioContextRef.current) return;

                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const detect = () => {
                    if (!analyserRef.current) return;
                    
                    analyserRef.current.getByteFrequencyData(dataArray);
                    
                    let maxValue = 0;
                    let maxIndex = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        if (dataArray[i] > maxValue) {
                            maxValue = dataArray[i];
                            maxIndex = i;
                        }
                    }
                    
                    if (maxValue > 50) {
                        const nyquist = audioContextRef.current.sampleRate / 2;
                        const frequency = (maxIndex * nyquist) / bufferLength;
                        
                        if (frequency > 80 && frequency < 500) {
                            setCurrentPitch(Math.round(frequency));
                        }
                    } else {
                        setCurrentPitch(0);
                    }
                    
                    pitchDetectionRef.current = requestAnimationFrame(detect);
                };
                
                detect();
            }, []);

            // Drone Controls
            const startDrone = useCallback(() => {
                if (!audioContextRef.current) return;

                try {
                    const osc = audioContextRef.current.createOscillator();
                    const gain = audioContextRef.current.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.value = notes[selectedNote];
                    gain.gain.value = 1; // Quieter for reading
                    
                    osc.connect(gain);
                    gain.connect(audioContextRef.current.destination);
                    
                    osc.start();
                    oscillatorRef.current = osc;
                    gainNodeRef.current = gain;
                    setIsDronePlaying(true);
                } catch (error) {
                    console.error('Drone error:', error);
                }
            }, [selectedNote]);

            const stopDrone = useCallback(() => {
                if (oscillatorRef.current) {
                    oscillatorRef.current.stop();
                    oscillatorRef.current = null;
                    setIsDronePlaying(false);
                }
            }, []);

            const togglePitchMonitor = useCallback(() => {
                setShowBubble(true);
            }, []);

            const adjustNote = useCallback((direction) => {
                const noteArray = Object.keys(notes);
                const currentIndex = noteArray.indexOf(selectedNote);
                let newIndex = direction === 'up' ? currentIndex + 1 : currentIndex - 1;
                newIndex = Math.max(0, Math.min(noteArray.length - 1, newIndex));
                const newNote = noteArray[newIndex];
                setSelectedNote(newNote);
                
                if (oscillatorRef.current) {
                    oscillatorRef.current.frequency.value = notes[newNote];
                }
            }, [selectedNote]);

            // Initialize on mount
            useEffect(() => {
                initAudio();
                
                return () => {
                    if (pitchDetectionRef.current) {
                        cancelAnimationFrame(pitchDetectionRef.current);
                    }
                    if (oscillatorRef.current) {
                        oscillatorRef.current.stop();
                    }
                    if (micStreamRef.current) {
                        micStreamRef.current.getTracks().forEach(track => track.stop());
                    }
                    if (audioContextRef.current) {
                        audioContextRef.current.close();
                    }
                };
            }, [initAudio]);

            const getPitchColor = () => {
                if (currentPitch === 0) return 'bg-gray-400';
                const target = notes[selectedNote];
                const diff = Math.abs(currentPitch - target);
                if (diff < 5) return 'bg-green-500';
                if (diff < 15) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            const getPitchStatus = () => {
                if (currentPitch === 0) return '---';
                const target = notes[selectedNote];
                const diff = currentPitch - target;
                if (Math.abs(diff) < 5) return `${currentPitch}`;
                if (diff > 0) return `${currentPitch}↓`;
                return `${currentPitch}↑`;
            };

            const getFontSizeClass = () => {
                switch(fontSize) {
                    case 'small': return 'text-base';
                    case 'large': return 'text-xl';
                    case 'xlarge': return 'text-2xl';
                    default: return 'text-lg';
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 safe-top safe-bottom">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-50 safe-top">
                        <div className="px-4 py-3">
                            <h1 className="text-2xl font-bold text-gray-800">Voice Training Reader</h1>
                            <p className="text-sm text-gray-600">Practice pitch while reading</p>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="p-4 pb-20">
                        {/* Microphone Permission */}
                        {micPermission === 'denied' && (
                            <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                                <p className="text-red-800">🎤 Microphone access required for pitch detection</p>
                                <button 
                                    onClick={initAudio}
                                    className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg"
                                >
                                    Grant Access
                                </button>
                            </div>
                        )}

                        {!selectedReading ? (
                            <>
                                {/* Drone Control */}
                                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                    <h2 className="text-xl font-semibold mb-4">Pitch Control</h2>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Target Note
                                        </label>
                                        <select 
                                            value={selectedNote}
                                            onChange={(e) => setSelectedNote(e.target.value)}
                                            className="w-full p-3 text-lg border border-gray-300 rounded-lg"
                                        >
                                            {Object.entries(notes).map(([note, freq]) => (
                                                <option key={note} value={note}>
                                                    {note} ({Math.round(freq)} Hz)
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <button
                                            onClick={isDronePlaying ? stopDrone : startDrone}
                                            disabled={!audioInitialized}
                                            className={`py-4 text-lg rounded-lg font-medium transition-colors ${
                                                !audioInitialized 
                                                    ? 'bg-gray-300 text-gray-500' 
                                                    : isDronePlaying 
                                                        ? 'bg-red-500 text-white' 
                                                        : 'bg-purple-500 text-white'
                                            }`}
                                        >
                                            {isDronePlaying ? '⏹ Stop Drone' : '▶ Start Drone'}
                                        </button>
                                        
                                        <button
                                            onClick={togglePitchMonitor}
                                            disabled={!audioInitialized}
                                            className={`py-4 text-lg rounded-lg font-medium transition-colors ${
                                                !audioInitialized 
                                                    ? 'bg-gray-300 text-gray-500' 
                                                    : showBubble
                                                        ? 'bg-green-500 text-white' 
                                                        : 'bg-blue-500 text-white'
                                            }`}
                                        >
                                            {showBubble ? '✓ Monitor On' : '👁 Show Monitor'}
                                        </button>
                                    </div>

                                    {audioInitialized && (
                                        <div className="text-center">
                                            <div className="text-sm text-gray-600">Current Pitch</div>
                                            <div className={`text-2xl font-bold ${
                                                currentPitch === 0 ? 'text-gray-400' :
                                                Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-green-500' :
                                                Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-yellow-500' :
                                                'text-red-500'
                                            }`}>
                                                {currentPitch > 0 ? `${currentPitch} Hz` : 'No signal'}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                Target: {Math.round(notes[selectedNote])} Hz
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Reading Selection */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Select Reading Material</h2>
                                    <div className="space-y-3">
                                        {readings.map(reading => (
                                            <button
                                                key={reading.id}
                                                onClick={() => setSelectedReading(reading)}
                                                className="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-purple-50 transition-colors"
                                            >
                                                <div className="font-semibold text-lg">{reading.title}</div>
                                                <div className="text-sm text-gray-600">{reading.description}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </>
                        ) : (
                            /* Reading View */
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <button
                                            onClick={() => setSelectedReading(null)}
                                            className="text-purple-600 mb-2"
                                        >
                                            ← Back
                                        </button>
                                        <h2 className="text-xl font-semibold">{selectedReading.title}</h2>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                const sizes = ['small', 'medium', 'large', 'xlarge'];
                                                const current = sizes.indexOf(fontSize);
                                                setFontSize(sizes[(current + 1) % sizes.length]);
                                            }}
                                            className="px-3 py-1 bg-gray-200 rounded-lg text-sm"
                                        >
                                            Aa
                                        </button>
                                    </div>
                                </div>
                                
                                <div className={`reading-text ${getFontSizeClass()} text-gray-800 whitespace-pre-wrap`}>
                                    {selectedReading.content}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Floating Bubble */}
                    {showBubble && (
                        <div className="floating-bubble">
                            {!bubbleExpanded ? (
                                <button
                                    onClick={() => setBubbleExpanded(true)}
                                    className={`w-20 h-16 rounded-full shadow-lg flex items-center justify-center text-white font-bold text-sm pitch-indicator ${getPitchColor()}`}
                                >
                                    {getPitchStatus()}
                                </button>
                            ) : (
                                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                                    <div className="flex justify-between items-center mb-3">
                                        <span className="font-semibold text-sm">Pitch Monitor</span>
                                        <button
                                            onClick={() => setBubbleExpanded(false)}
                                            className="text-gray-500 text-xl"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    
                                    <div className="text-center mb-3">
                                        <div className={`text-2xl font-bold ${
                                            currentPitch === 0 ? 'text-gray-400' :
                                            Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-green-500' :
                                            Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-yellow-500' :
                                            'text-red-500'
                                        }`}>
                                            {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            onClick={() => adjustNote('down')}
                                            className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                                        >
                                            ↓
                                        </button>
                                        <button
                                            onClick={() => adjustNote('up')}
                                            className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                                        >
                                            ↑
                                        </button>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <button
                                            onClick={isDronePlaying ? stopDrone : startDrone}
                                            className={`flex-1 py-2 rounded-lg text-sm text-white ${
                                                isDronePlaying ? 'bg-red-500' : 'bg-green-500'
                                            }`}
                                        >
                                            {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowBubble(false);
                                                setBubbleExpanded(false);
                                            }}
                                            className="px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
                                        >
                                            Hide
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VoiceTrainingReader />);
    </script>
</body>
</html>
